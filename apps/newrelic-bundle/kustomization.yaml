apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - instrumentation-crs.yaml

helmCharts:
  - name: nri-bundle
    repo: https://newrelic.github.io/helm-charts
    version: 6.0.21
    releaseName: nri-bundle
    namespace: newrelic
    valuesInline:
      # ... (your valuesInline section is perfect, no changes) ...
      global:
        cluster: kmullaney-gts-training-k8s-8
        customSecretName: "newrelic-secrets"
        customSecretLicenseKey: "newRelicLicenseKey"
        fargate: true
        privileged: true
      newrelic-prometheus-agent:
        enabled: true
        config:
          kubernetes:
            jobs:
            - job_name_prefix: prometheus-scrape
              target_discovery:
                endpoints: true
                filter:
                  annotations:
                    prometheus.io/scrape: true
                pod: true
            integrations_filter:
              app_values:
              - java-app-service
              - express-app-service
              - python-app-service
              enabled: true
              source_labels:
              - app.kubernetes.io/name
      nri-metadata-injection:
        enabled: true
      k8s-agents-operator:
        enabled: true
        customSecretName: "newrelic-secrets"
      newrelic-infra-operator:
        enabled: true
        tolerations:
        - key: "eks.amazonaws.com/compute-type"
          operator: "Equal"
          value: "fargate"
          effect: "NoSchedule"
      newrelic-infrastructure:
        enabled: true
        prefixDisplayNameWithCluster: true
        useNodeNameAsDisplayName: true
      kube-state-metrics:
        enabled: true
      nri-kube-events:
        enabled: true
      newrelic-logging:
        enabled: true

# These are the *only* patches needed. They solve the x509 error
# by ensuring the operator is ready before the CRs are applied.
# All other hooks (...-admission-create jobs) are handled by Helm.
patches:
  # --- WAVE -10: CRD ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10" # Corrected typo
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- WAVE -5: K8S AGENTS OPERATOR (The webhook server) ---
  - target:
      kind: "Deployment|Service"
      name: "nri-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5" # Corrected typo
  - target:
      kind: "ServiceAccount|ClusterRole|ClusterRoleBinding"
      name: "nri-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5" # Corrected typo
          argocd.argoproj.io/sync-options: "Replace=true" # Prevents "already exists"

  # --- WAVE 5: INSTRUMENTATION CRs (The webhook clients) ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5" # Corrected typo
