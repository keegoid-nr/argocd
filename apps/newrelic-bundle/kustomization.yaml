apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - nri-bundle-manifests.yaml
  - instrumentation-crs.yaml

patches:
  # --- WAVE -10: CRD ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10"
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- WAVE -5: "EMPTY" WEBHOOKS & MAIN OPERATOR RBAC ---
  - target:
      kind: "MutatingWebhookConfiguration|ValidatingWebhookConfiguration"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
  - target:
      kind: "ServiceAccount|ClusterRole|ClusterRoleBinding"
      name: "nri-bundle-(k8s-agents-operator.*|newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
          argocd.argoproj.io/sync-options: "Replace=true"

  # --- WAVE -4: RBAC FOR CERT-PATCH JOBS ---
  # This MUST be in a separate, earlier wave than the jobs themselves
  # to solve the 'serviceaccount not found' error.
  - target:
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "nri-bundle-.*-admission"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"
  
  # --- WAVE -3: CERT-PATCH JOBS (w/ K8s 1.25+ FIX) ---
  # These jobs run *after* their RBAC is created in Wave -4.
  - target:
      kind: Job
      name: newrelic-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-newrelic-infra-operator-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-newrelic-infra-operator-admission-create

  - target:
      kind: Job
      name: newrelic-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-nri-metadata-injection-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-nri-metadata-injection-admission-create

  # --- WAVE -2: OPERATORS THAT MOUNT CERTS ---
  - target:
      kind: "Deployment|Service"
      name: "nri-bundle-(newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  # --- WAVE -1: K8S AGENTS OPERATOR ---
  - target:
      kind: "Deployment|Service"
      name: "nri-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-1"

  # --- WAVE 5: INSTRUMENTATION CRs ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5"

  # --- FINAL FIX: REMOVE ALL HELM HOOKS ---
  - target:
      annotationSelector: "helm.sh/hook"
    patch: |
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
