apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - nri-bundle-manifests.yaml
  - instrumentation-crs.yaml

patches:
  # --- WAVE -10: CRD ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argopj.io/sync-wave: "-10"
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- PRE-WAVE: INITIALIZE NULL ANNOTATIONS ---
  # These patches find the two ServiceAccounts with 'annotations: null'
  # and replace 'null' with an empty map '{}' so we can add to them.
  - target:
      kind: ServiceAccount
      name: "newrelic-bundle-k8s-agents-operator"
    patch: |
      - op: add
        path: /metadata/annotations
        value: {}
  - target:
      kind: ServiceAccount
      name: "newrelic-bundle-nri-kube-events"
    patch: |
      - op: add
        path: /metadata/annotations
        value: {}

  # --- WAVE -5: "EMPTY" WEBHOOKS & CATCH-ALL MAIN RBAC ---
  - target:
      kind: "MutatingWebhookConfiguration|ValidatingWebhookConfiguration"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
  - target:
      # This "catch-all" for ALL RBAC uses the "add key" syntax
      # which is resilient to missing 'annotations' keys.
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "-5"
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-options
        value: "Replace=true"

  # --- WAVE -4: RBAC FOR CERT-PATCH JOBS ---
  # This more specific patch OVERRIDES the Wave -5 patch.
  - target:
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "newrelic-bundle-.*-admission"
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "-4"

  # --- WAVE -3: CERT-PATCH JOBS (w/ K8s 1.25+ FIX) ---
  - target:
      kind: Job
      name: newrelic-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-newrelic-infra-operator-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-newrelic-infra-operator-admission-create

  - target:
      kind: Job
      name: newrelic-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-nri-metadata-injection-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-nri-metadata-injection-admission-create
        
  # --- WAVE -2: OPERATORS THAT MOUNT CERTS ---
  - target:
      kind: "Deployment|Service"
      name: "newrelic-bundle-(newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  # --- WAVE -1: K8S AGENTS OPERATOR ---
  - target:
      kind: "Deployment|Service"
      name: "newrelic-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-1"

  # --- WAVE 5: INSTRUMENTATION CRs ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5"

  # --- CLEANUP: MOVE THE "PATCH" JOBS ---
  - target:
      kind: Job
      name: "newrelic-bundle-.*-admission-patch"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "10"
