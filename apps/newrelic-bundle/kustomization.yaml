apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# We use the static manifest file, not the helmCharts: feature.
# This gives us full control and avoids conflicts with Helm's hook logic.
resources:
  - nri-bundle-manifests.yaml
  - instrumentation-crs.yaml

patches:
  # --- WAVE -10: CRD ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10"
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- WAVE -5: "EMPTY" WEBHOOKS & MAIN OPERATOR RBAC ---
  - target:
      # Targets all webhook configurations
      kind: "MutatingWebhookConfiguration|ValidatingWebhookConfiguration"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
  - target:
      # Targets RBAC for all main operators
      kind: "ServiceAccount|ClusterRole|ClusterRoleBinding"
      name: "nri-bundle-(k8s-agents-operator.*|newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
          argocd.argoproj.io/sync-options: "Replace=true"

  # --- WAVE -4: CERT-PATCH JOBS & THEIR RBAC (w/ K8s 1.25+ FIX) ---
  - target:
      # Targets all RBAC for the ...-admission jobs
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "nri-bundle-.*-admission"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"
  
  - target:
      # infra-operator job patch
      kind: Job
      name: newrelic-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-newrelic-infra-operator-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-newrelic-infra-operator-admission-create

  - target:
      # metadata-injection job patch
      kind: Job
      name: newrelic-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-nri-metadata-injection-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-nri-metadata-injection-admission-create

  # --- WAVE -3: OPERATORS THAT MOUNT CERTS ---
  - target:
      # Targets Deployments/Services for infra-operator and metadata-injection
      kind: "Deployment|Service"
      name: "nri-bundle-(newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"

  # --- WAVE -2: K8S AGENTS OPERATOR ---
  - target:
      kind: "Deployment|Service"
      name: "nri-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  # --- WAVE 5: INSTRUMENTATION CRs ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5"

  # --- FINAL FIX: REMOVE ALL HELM HOOKS ---
  # This patch finds every resource that has a 'helm.sh/hook' annotation
  # and removes it, giving 100% control to our sync waves.
  - target:
      annotationSelector: "helm.sh/hook"
    patch: |
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
