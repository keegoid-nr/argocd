apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
  # CHART 1: nri-bundle (remote)
  - name: nri-bundle
    repo: https://newrelic.github.io/helm-charts
    version: 6.0.17
    releaseName: nri-bundle
    namespace: newrelic
    valuesInline:
      # https://github.com/newrelic/helm-charts/blob/master/charts/nri-bundle
      global:
        cluster: kmullaney-gts-training-k8s-8
        customSecretName: "newrelic-secrets"
        customSecretLicenseKey: "newRelicLicenseKey"
        fargate: true
        privileged: true
      # https://github.com/newrelic/nri-prometheus/tree/main/charts/nri-prometheus
      # nri-prometheus:
      #   enabled: true
      #   config:
      #     scrape_endpoints: true
      #     scrape_services: false
      #     lowDataMode: true
      #     insecure_skip_verify: true
      #     require_scrape_enabled_label_for_nodes: false
      #     transformations:
      #     - description: "Add and rename some attributes"
      #       add_attributes:
      #       - metric_prefix: ""
      #         attributes:
      #           env: "development"
      #           region: "us-west-2"
      #       rename_attributes:
      #       - metric_prefix: ""
      #         attributes:
      #           result: "result_new"
      #           table: "table_new"
      # https://github.com/newrelic/nri-prometheus/blob/main/charts/nri-prometheus
      newrelic-prometheus-agent:
        enabled: true
        config:
          kubernetes:
            jobs:
            - job_name_prefix: prometheus-scrape
              target_discovery:
                endpoints: true
                filter:
                  annotations:
                    prometheus.io/scrape: true
                pod: true
            integrations_filter:
              app_values:
              - java-app-service
              - express-app-service
              - python-app-service
              enabled: true
              source_labels:
              - app.kubernetes.io/name
      # https://github.com/newrelic/k8s-metadata-injection/tree/main/charts/nri-metadata-injection
      nri-metadata-injection:
        enabled: true
      # https://github.com/newrelic/k8s-agents-operator/tree/main/charts/k8s-agents-operator
      k8s-agents-operator:
        enabled: true
      # https://github.com/newrelic/newrelic-infra-operator/tree/main/charts/newrelic-infra-operator
      newrelic-infra-operator:
        enabled: true
        tolerations:
        - key: "eks.amazonaws.com/compute-type"
          operator: "Equal"
          value: "fargate"
          effect: "NoSchedule"
      # https://github.com/newrelic/nri-kubernetes/tree/main/charts/newrelic-infrastructure
      newrelic-infrastructure:
        enabled: true
        prefixDisplayNameWithCluster: true
        useNodeNameAsDisplayName: true
      # https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics
      kube-state-metrics:
        enabled: true
      # https://github.com/newrelic/nri-kube-events/tree/main/charts/nri-kube-events
      nri-kube-events:
        enabled: true
      # https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-logging
      newrelic-logging:
        enabled: true

  # CHART 2: Instrumentation CRDs (local)
  - name: newrelic-instrumentation-crds
    repo: file://newrelic-instrumentation-crds
    releaseName: newrelic-instrumentation-crds
    namespace: newrelic
    valuesInline:
      awsAccountId: "368927449855"

patches:
  # WAVE -10: The CRD itself. This MUST exist first.
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoj.io/sync-wave: "-10"

  # WAVE -5: ServiceAccounts & Permissions
  - target:
      kind: ServiceAccount
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoj.io/sync-wave: "-5"

  # WAVE -4: The Webhook Service
  - target:
      kind: Service
      name: nri-bundle-k8s-agents-operator-webhook-service
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoj.io/sync-wave: "-4"

  # WAVE -3: The Operator Deployment
  - target:
      kind: Deployment
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoj.io/sync-wave: "-3"

  # --- CUSTOM RESOURCE WAVES (from newrelic-instrumentation-crds) ---

  # WAVE 5 (or any positive wave): the actual CRs
  # This targets all 'Instrumentation' kinds generated by the local chart
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoj.io/sync-wave: "5"

  # --- AUTO-CLEANUP FOR HELM HOOK JOBS ---
  # This patch finds the two setup jobs and tells Kubernetes
  # to delete them 600 seconds (10 minutes) after they complete.
  # This prevents them from getting stuck by finalizers on deletion.

  - target:
      kind: Job
      name: nri-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /spec/ttlSecondsAfterFinished
        value: 600

  - target:
      kind: Job
      name: nri-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /spec/ttlSecondsAfterFinished
        value: 600
