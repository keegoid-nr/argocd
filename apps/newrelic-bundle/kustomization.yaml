apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# --- Argo CD Sync Wave Strategy ---
#
# This kustomization uses Argo CD sync waves to solve a common
# "chicken-and-egg" problem with operator webhooks.
#
# The Problem: Admission webhooks must be patched with a 'caBundle',
# which is generated by a Job. But that Job can't run, and the
# operator pod itself can't start, if the webhook configuration
# is already active but failing (because it has no caBundle).
# This ordered sync breaks that loop.
#
# --- Sync Wave Breakdown ---
#
# Wave -10: Apply CRDs
#   - What: The 'instrumentations.newrelic.com' CustomResourceDefinition.
#   - Why: The cluster MUST know about the new 'Instrumentation' resource
#     type before anything else. We also patch 'spec/conversion'
#     to 'strategy: None' to prevent Argo CD and the operator
#     from "fighting" over this field (which you should handle with
#     'ignoreDifferences' in the Argo CD Application).
#
# Wave -5: Stage Operators and "Empty" Webhooks
#   - What: All RBAC, the operator Deployments (infra-operator,
#     metadata-injection), their Services, and their
#     MutatingWebhookConfiguration resources (still empty).
#   - Why: This creates all the necessary "targets" for the patch
#     jobs to find. The operators start deploying, and the
#     webhooks exist but are not yet active/blocking.
#
# Wave -4: Generate Certificates
#   - What: The '...-admission-create' Jobs.
#   - Why: These jobs run, generate TLS certs, and patch the
#     'caBundle' into the webhooks created in Wave -5. This makes
#     the webhooks "live". The 'Replace=true' sync-option
#     ensures new certs are created on every upgrade,
#     preventing TLS errors.
#
# Wave -3 & -2: Deploy the 'k8s-agents-operator'
#   - What: The main operator's Service (Wave -3) and then its
#     Deployment (Wave -2).
#   - Why: This operator can now safely start. Its own CRD
#     (Wave -10) exists, and the *other* webhooks (Waves -5/-4)
#     are now healthy and won't block its pod creation.
#
# Wave 5: Apply Custom Resource (CR) Instances
#   - What: The 'Instrumentation' CRs from 'instrumentation-crs.yaml'.
#   - Why: Apply the CR instances *last*. This ensures the operator
#     (from Wave -2) that manages them is fully running and ready
#     to process them immediately.

resources:
  - instrumentation-crs.yaml

helmCharts:
  - name: nri-bundle
    repo: https://newrelic.github.io/helm-charts
    version: 6.0.21
    releaseName: nri-bundle # This must match the 'nri-bundle-' prefix below
    namespace: newrelic
    valuesInline:
      # https://github.com/newrelic/helm-charts/blob/master/charts/nri-bundle
      global:
        cluster: kmullaney-gts-training-k8s-8
        customSecretName: "newrelic-secrets"
        customSecretLicenseKey: "newRelicLicenseKey"
        fargate: true
        privileged: true
      # https://github.com/newrelic/nri-prometheus/tree/main/charts/nri-prometheus
      # nri-prometheus:
      #   enabled: true
      #   config:
      #     scrape_endpoints: true
      #     scrape_services: false
      #     lowDataMode: true
      #     insecure_skip_verify: true
      #     require_scrape_enabled_label_for_nodes: false
      #     transformations:
      #     - description: "Add and rename some attributes"
      #       add_attributes:
      #       - metric_prefix: ""
      #         attributes:
      #           env: "development"
      #           region: "us-west-2"
      #       rename_attributes:
      #       - metric_prefix: ""
      #         attributes:
      #           result: "result_new"
      #           table: "table_new"
      # https://github.com/newrelic/nri-prometheus/blob/main/charts/nri-prometheus
      newrelic-prometheus-agent:
        enabled: true
        config:
          kubernetes:
            jobs:
            - job_name_prefix: prometheus-scrape
              target_discovery:
                endpoints: true
                filter:
                  annotations:
                    prometheus.io/scrape: true
                pod: true
            integrations_filter:
              app_values:
              - java-app-service
              - express-app-service
              - python-app-service
              enabled: true
              source_labels:
              - app.kubernetes.io/name
      # https://github.com/newrelic/k8s-metadata-injection/tree/main/charts/nri-metadata-injection
      nri-metadata-injection:
        enabled: true
      # https://github.com/newrelic/k8s-agents-operator/tree/main/charts/k8s-agents-operator
      k8s-agents-operator:
        enabled: true
        customSecretName: "newrelic-secrets"
      # https://github.com/newrelic/newrelic-infra-operator/tree/main/charts/newrelic-infra-operator
      newrelic-infra-operator:
        enabled: true
        tolerations:
        - key: "eks.amazonaws.com/compute-type"
          operator: "Equal"
          value: "fargate"
          effect: "NoSchedule"
      # https://github.com/newrelic/nri-kubernetes/tree/main/charts/newrelic-infrastructure
      newrelic-infrastructure:
        enabled: true
        prefixDisplayNameWithCluster: true
        useNodeNameAsDisplayName: true
      # https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-state-metrics
      kube-state-metrics:
        enabled: true
      # https://github.com/newrelic/nri-kube-events/tree/main/charts/nri-kube-events
      nri-kube-events:
        enabled: true
      # https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-logging
      newrelic-logging:
        enabled: true

patches:
# Wave -10: CRD is created.
# Wave -5: ServiceAccounts, Operator Deployments, Operator Services, and the (empty) MutatingWebhookConfigurations are all created.
# Wave -4: The Jobs run. They find the webhooks from Wave -5, generate new certs, and patch the caBundle into them.
# Wave -3/-2: Other k8s-agents-operator components are created.
# Wave 5: Instrumentation CRs are created.

  # --- WAVE -10: CRDs. This MUST exist first. ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10"
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- WAVE -5: OPERATOR RBAC & EMPTY WEBHOOK CONFIGS ---
  - target:
      # This patch is for the OPERATOR RBAC (not the job RBAC)
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "nri-bundle-(newrelic-infra-operator|nri-metadata-injection)$" # Regex for the main operator SA/RBAC
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
          
  - target:
      # These must be created *before* the Wave -4 jobs can patch them
      kind: MutatingWebhookConfiguration
      name: nri-bundle-newrelic-infra-operator
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"

  - target:
      kind: MutatingWebhookConfiguration
      name: nri-bundle-nri-metadata-injection
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"

  # --- WAVE -4: BATCH JOBS & THEIR RBAC ---
  # Run the jobs to create the secrets
  - target:
      kind: Job
      name: nri-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"

  - target:
      kind: Job
      name: nri-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"

  # This is the RBAC for the JOBS (not the operators)
  - target:
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "nri-bundle-.*-admission" # Regex for all ...-admission RBAC
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-4"
          argocd.argoproj.io/sync-options: "Replace=true"

  # --- WAVE -3: OPERATOR DEPLOYMENTS & SERVICES ---
  # Now that secrets exist, start the operators that mount them.
  - target:
      kind: Deployment
      name: nri-bundle-newrelic-infra-operator
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"

  - target:
      kind: Service
      name: nri-bundle-newrelic-infra-operator # Corrected name
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"

  - target:
      kind: Deployment
      name: nri-bundle-nri-metadata-injection
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"

  - target:
      kind: Service
      name: nri-bundle-nri-metadata-injection # Corrected name
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-3"
  
  # --- WAVE -2: K8S AGENTS OPERATOR (Deployment & Service) ---
  - target:
      kind: ServiceAccount
      name: nri-bundle-k8s-agents-operator
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"
          
  - target:
      kind: Service
      name: nri-bundle-k8s-agents-operator-webhook-service
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  - target:
      kind: Deployment
      name: nri-bundle-k8s-agents-operator
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  # --- WAVE 5: CUSTOM RESOURCE WAVES (from instrumentation-crs) ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5"
