apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - nri-bundle-manifests.yaml
  - instrumentation-crs.yaml

patches:
  # --- WAVE -10: CRD ---
  - target:
      kind: CustomResourceDefinition
      name: instrumentations.newrelic.com
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-10"
      - op: replace
        path: /spec/conversion
        value:
          strategy: None

  # --- WAVE -5: "EMPTY" WEBHOOKS & CATCH-ALL MAIN RBAC ---
  - target:
      kind: "MutatingWebhookConfiguration|ValidatingWebhookConfiguration"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
  - target:
      # This is the "catch-all" for all NON-ADMISSION RBAC.
      # It uses a negative lookahead regex to ignore names ending in "-admission".
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "^newrelic-bundle-(?!.*-admission$).*$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-5"
          argocd.argoproj.io/sync-options: "Replace=true"

  # --- WAVE -4: RBAC FOR CERT-PATCH JOBS (HOOK REMOVAL) ---
  # This patch finds all "...-admission" RBAC, removes their hook annotations,
  # and assigns them to Wave -4.
  - target:
      kind: "ServiceAccount|Role|ClusterRole|RoleBinding|ClusterRoleBinding"
      name: "newrelic-bundle-.*-admission"
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "-4"
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-options
        value: "Replace=true"
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
  
  # --- WAVE -3: CERT-PATCH JOBS (HOOK REMOVAL + K8s FIX) ---
  # This patch finds the "...-admission-create" Jobs, removes their hooks,
  # assigns them to Wave -3, and applies the K8s 1.25+ fixes.
  - target:
      kind: Job
      name: newrelic-bundle-newrelic-infra-operator-admission-create
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "-3"
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-options
        value: "Replace=true"
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-newrelic-infra-operator-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-newrelic-infra-operator-admission-create

  - target:
      kind: Job
      name: newrelic-bundle-nri-metadata-injection-admission-create
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "-3"
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-options
        value: "Replace=true"
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
      - op: add
        path: /spec/selector
        value: {}
      - op: add
        path: /spec/selector/matchLabels
        value:
          job-name: newrelic-bundle-nri-metadata-injection-admission-create
      - op: add
        path: /spec/template/metadata/labels/job-name
        value: newrelic-bundle-nri-metadata-injection-admission-create
        
  # --- WAVE -2: OPERATORS THAT MOUNT CERTS ---
  - target:
      kind: "Deployment|Service"
      name: "newrelic-bundle-(newrelic-infra-operator|nri-metadata-injection)$"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-2"

  # --- WAVE -1: K8S AGENTS OPERATOR ---
  - target:
      kind: "Deployment|Service"
      name: "newrelic-bundle-k8s-agents-operator.*"
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "-1"

  # --- WAVE 5: INSTRUMENTATION CRs ---
  - target:
      kind: Instrumentation
    patch: |
      - op: add
        path: /metadata/annotations
        value:
          argocd.argoproj.io/sync-wave: "5"

  # --- CLEANUP: REMOVE THE "PATCH" JOBS ---
  # We don't need the "...-admission-patch" jobs, as the "...-create"
  # jobs already generate the certs. This patch defangs their hooks
  # and also moves them to a late wave just to be safe.
  - target:
      kind: Job
      name: "newrelic-bundle-.*-admission-patch"
    patch: |
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "10"
      - op: remove
        path: /metadata/annotations/helm.sh~1hook
      - op: remove
        path: /metadata/annotations/helm.sh~1hook-delete-policy
